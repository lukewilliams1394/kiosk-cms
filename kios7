#!/bin/bash
# Ubuntu 24.04.3 → Microsoft Edge Kiosk with Animated Plymouth Splash
# Run as root

set -e

echo "=== Updating system ==="
apt update && apt upgrade -y

echo "=== Installing required packages ==="
apt install --no-install-recommends -y \
    xorg openbox xinit dbus-x11 pulseaudio alsa-utils \
    curl wget nano systemd-cron espeak-ng xdg-utils x11-xserver-utils \
    plymouth plymouth-themes

echo "=== Adding Microsoft Edge repository ==="
curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" \
    > /etc/apt/sources.list.d/microsoft-edge.list
apt update
apt install microsoft-edge-stable -y
rm microsoft.gpg

echo "=== Disabling network-wait ==="
systemctl disable systemd-networkd-wait-online.service
systemctl mask systemd-networkd-wait-online.service

echo "=== Creating kiosk user ==="
if ! id "kiosk" &>/dev/null; then
    adduser kiosk --gecos "" --disabled-password
fi

echo "=== Enabling auto-login ==="
mkdir -p /etc/systemd/system/getty@tty1.service.d
cat >/etc/systemd/system/getty@tty1.service.d/override.conf <<'EOF'
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin kiosk --noclear %I $TERM
Type=idle
EOF
systemctl daemon-reexec
systemctl daemon-reload

echo "=== Setting up kiosk environment ==="
su - kiosk -s /bin/bash <<'EOF'
set -e

# Auto-start X when logging in on tty1
cat > ~/.bash_profile <<'EOB'
if [ -z "$DISPLAY" ] && [ "$(tty)" = "/dev/tty1" ]; then
  startx
fi
EOB

# X session startup script
cat > ~/.xinitrc <<'EOC'
#!/bin/bash
xset s off
xset -dpms
xset s noblank

pulseaudio --start
sleep 1
amixer -D pulse sset Master 100% || true

TARGET_URL="http://server02:4040/Tracking/Scanner"

while true; do
    pkill microsoft-edge || true
    sleep 1
    microsoft-edge --kiosk "$TARGET_URL" \
        --no-first-run \
        --disable-infobars \
        --autoplay-policy=no-user-gesture-required \
        --window-size=1920,1080 \
        --window-position=0,0 >/dev/null 2>&1 &
    EDGE_PID=$!
    wait $EDGE_PID || true
    echo "[KIOSK] Edge closed or crashed — restarting..."
    sleep 2
done
EOC

chmod +x ~/.xinitrc
EOF

echo "=== Configuring X11 resolution ==="
mkdir -p /etc/X11/xorg.conf.d
cat >/etc/X11/xorg.conf.d/10-monitor.conf <<'EOF'
Section "Monitor"
    Identifier "Monitor0"
    Option "PreferredMode" "1920x1080"
EndSection
Section "Screen"
    Identifier "Screen0"
    Device "Device0"
    Monitor "Monitor0"
    SubSection "Display"
        Modes "1920x1080"
    EndSubSection
EndSection
EOF

echo "=== Setting up daily reboot ==="
systemctl mask ctrl-alt-del.target
cat >/etc/cron.d/kiosk-reboot <<'EOF'
0 3 * * * root /sbin/reboot
EOF
chmod 644 /etc/cron.d/kiosk-reboot

echo "=== Creating animated Plymouth splash with fade-out ==="
apt install -y plymouth plymouth-themes

mkdir -p /usr/share/plymouth/themes/centralmailing-kiosk

cat >/usr/share/plymouth/themes/centralmailing-kiosk/centralmailing-kiosk.plymouth <<'EOF'
[Plymouth Theme]
Name=Central Mailing Kiosk
Description=Blue pulsing text with fade-out
ModuleName=script

[script]
ImageDir=/usr/share/plymouth/themes/centralmailing-kiosk
ScriptFile=/usr/share/plymouth/themes/centralmailing-kiosk/centralmailing-kiosk.script
EOF

cat >/usr/share/plymouth/themes/centralmailing-kiosk/centralmailing-kiosk.script <<'EOF'
// Black background, subtle pulsing blue text, fades out before session
Window.SetBackgroundTopColor (0.0, 0.0, 0.0);
Window.SetBackgroundBottomColor (0.0, 0.0, 0.0);

var baseColor = [48/255.0, 85/255.0, 160/255.0];
var screen_w = Window.GetWidth();
var screen_h = Window.GetHeight();
var opacity = 1.0;
var fade_out = false;
var done = false;

fun draw_text(text, size, y_offset, r, g, b, a) {
    var t = Text(text, r, g, b);
    t.SetOpacity(a);
    t.SetFont("Arial Bold " + size);
    t.SetY(screen_h / 2 + y_offset);
    t.SetX((screen_w - t.GetWidth()) / 2);
    return t;
}

var phase = 0.0;
var text = draw_text("Loading Scanning Station…", 28, 0, baseColor[0], baseColor[1], baseColor[2], 1.0);

fun animate() {
    if (done) return false;

    phase += 0.08;
    var pulse = (sin(phase) + 1.0) / 2.0;
    var brightness = 0.6 + (pulse * 0.4);
    if (fade_out) {
        opacity -= 0.03;
        if (opacity <= 0) {
            opacity = 0;
            done = true;
            return false;
        }
    }

    text.SetColor(baseColor[0] * brightness, baseColor[1] * brightness, baseColor[2] * brightness);
    text.SetOpacity(opacity);
    text.Draw();
    Plymouth.Sleep(0.05);
    return true;
}

// Trigger fade-out when boot finishes
Plymouth.OnQuit = function() {
    fade_out = true;
    while (!done) {
        animate();
    }
}

Plymouth.SetUpdateFunction(animate);
EOF

# Register and set as the default Plymouth theme manually
update-alternatives --install /usr/share/plymouth/themes/default.plymouth default.plymouth /usr/share/plymouth/themes/centralmailing-kiosk/centralmailing-kiosk.plymouth 100
update-alternatives --set default.plymouth /usr/share/plymouth/themes/centralmailing-kiosk/centralmailing-kiosk.plymouth

# Rebuild initramfs so the new splash applies at boot
update-initramfs -u

# Silence all boot text and show only splash
sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash loglevel=0 vt.global_cursor_default=0"/' /etc/default/grub
update-grub

echo "=== Installation complete. Rebooting in 5 seconds ==="
sleep 5
reboot
