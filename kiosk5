#!/bin/bash
# Ubuntu 24.04.3 Server â†’ Microsoft Edge Single-Page Kiosk
# Run as root

set -e

echo "=== Updating system ==="
apt update && apt upgrade -y

echo "=== Installing core packages ==="
apt install --no-install-recommends -y \
    xorg openbox xinit dbus-x11 pulseaudio alsa-utils \
    curl wget nano systemd-cron espeak espeak-ng xdg-utils x11-xserver-utils

echo "=== Adding Microsoft Edge repository and installing Edge ==="
curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge.list'
apt update
apt install microsoft-edge-stable -y
rm microsoft.gpg

echo "=== Disabling systemd-networkd-wait-online ==="
systemctl disable systemd-networkd-wait-online.service
systemctl mask systemd-networkd-wait-online.service

# Create kiosk user if missing
if ! id "kiosk" &>/dev/null; then
    adduser kiosk --gecos "" --disabled-password
fi

echo "=== Configuring auto-login ==="
mkdir -p /etc/systemd/system/getty@tty1.service.d
cat >/etc/systemd/system/getty@tty1.service.d/override.conf <<'EOF'
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin kiosk --noclear %I $TERM
Type=idle
EOF
systemctl daemon-reexec
systemctl daemon-reload

echo "=== Setting up kiosk environment for 'kiosk' user ==="
su - kiosk -s /bin/bash <<'EOF'
set -e

# Auto-start X session
cat > ~/.bash_profile <<'EOB'
if [ -z "$DISPLAY" ] && [ "$(tty)" = "/dev/tty1" ]; then
  startx
fi
EOB

# X session startup
cat > ~/.xinitrc <<'EOC'
#!/bin/bash
xset s off
xset -dpms
xset s noblank

# Force display resolution to 1920x1080
XRANDR_OUTPUT=$(xrandr | grep ' connected' | awk '{print $1}')
xrandr --output "$XRANDR_OUTPUT" --mode 1920x1080

# Start PulseAudio
pulseaudio --start
sleep 2
amixer -D pulse sset Master 100% || true

TARGET_URL="http://server02:4040/Tracking/Scanner"
OFFLINE_FLAG=1
ONLINE_FLAG=0

while true; do
    # Wait for network connectivity
    while ! ping -c1 8.8.8.8 &>/dev/null; do
        if [ $OFFLINE_FLAG -eq 0 ]; then
            espeak-ng "Attention. The scanning station is offline."
            OFFLINE_FLAG=1
            ONLINE_FLAG=0
        fi
        sleep 5
    done

    if [ $ONLINE_FLAG -eq 0 ]; then
        espeak-ng "Network restored. Scanning station live."
        ONLINE_FLAG=1
        OFFLINE_FLAG=0
    fi

    # Kill any existing Edge instances
    pkill microsoft-edge || true
    sleep 1

    # Launch Edge in kiosk/fullscreen mode
    sleep 1
    microsoft-edge --kiosk "$TARGET_URL" \
        --no-first-run \
        --disable-infobars \
        --autoplay-policy=no-user-gesture-required \
        --window-size=1920,1080 \
        --window-position=0,0 >/dev/null 2>&1 &
    EDGE_PID=$!

    # Wait until Edge crashes or is killed
    while kill -0 $EDGE_PID 2>/dev/null; do
        sleep 5
    done

    echo "Edge crashed or closed. Restarting in 5s..."
    sleep 5
done
EOC

chmod +x ~/.xinitrc
EOF

# Force 1920x1080 resolution in X config
mkdir -p /etc/X11/xorg.conf.d
cat >/etc/X11/xorg.conf.d/10-monitor.conf <<'EOF'
Section "Monitor"
    Identifier "Monitor0"
    Option "PreferredMode" "1920x1080"
EndSection
Section "Screen"
    Identifier "Screen0"
    Device "Device0"
    Monitor "Monitor0"
    SubSection "Display"
        Modes "1920x1080"
    EndSubSection
EndSection
EOF

# Hardening & daily reboot
systemctl mask ctrl-alt-del.target
cat >/etc/cron.d/kiosk-reboot <<'EOF'
0 3 * * * root /sbin/reboot
EOF
chmod 644 /etc/cron.d/kiosk-reboot

echo "=== Setup complete. Rebooting in 5 seconds ==="
sleep 5
reboot
